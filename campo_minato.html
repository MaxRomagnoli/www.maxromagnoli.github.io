<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Campo Minato</title>
		
	<!-- CSS -->
	<link rel="stylesheet" type="text/css" href="bootstrap-5.0.2-dist/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="win95/win95.css"> <!--https://alexbsoft.github.io/win95.css-->

	<style>
		#game {
			width: 100%;
			margin: 0 auto;
			border: 1px solid #1a1a1a;
			table-layout: fixed;
		}

		#game.game-over {
			opacity: 0.5;
		}

		#game tr td {
			text-align: center;
			border-width: 2px;
		    border-color: buttonface;
		    border-right-color: #424242;
		    border-bottom-color: #424242;
		    background-color: silver;
		    color: black;
		    border-radius: 1px;
		}

		#game tr td span {
			position: absolute;
		    left: 50%;
		    top: 50%;
		    transform: translate(-50%, -50%);

		    /* NOSELECT */
			-webkit-touch-callout: none; /* iOS Safari */
			-webkit-user-select: none; /* Safari */
			-khtml-user-select: none; /* Konqueror HTML */
			-moz-user-select: none; /* Old versions of Firefox */
			-ms-user-select: none; /* Internet Explorer/Edge */
			user-select: none; /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
		}

		.item-red {
			background-color: red!important;
		}

		.item-yellow {
			background-color: yellow!important;
		}

		.item-green {
			background-color: lightgreen!important;
		}

		.text-red {
			color: red!important;
		}

		.square {
		  position: relative;
		}

		.square::after {
		  content: "";
		  display: block;
		  padding-bottom: 100%;
		}

	</style>
</head>
<body oncontextmenu="return false;">

	<div class="container" id="page-content">
        <div class="card-deck mb-3 text-center">
            <div class="card my-4">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Campo minato (<span id="n-mines"></span> mine)</h4>
                </div>
				<table id="game"></table>
            </div>
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Options</h4>
                </div>
				<button type="button" class="btn btn-lg btn-block btn-outline-primary" onclick="initializeGame()">
					New game easy
				</button>
				<button type="button" class="btn btn-lg btn-block btn-outline-primary" onclick="initializeGame(16, 16, 40)">
					New game normal
				</button>
				<button type="button" class="btn btn-lg btn-block btn-outline-primary" onclick="initializeGame(30, 16, 99)">
					New game hard
				</button>
            </div>
        </div>
    </div>

	<script src="jquery/3.7.1/jquery.min.js"></script>
	<script>

		var matrix; // array di array, x è una mina
		var visible_matrix; // array di array, vuoti o conteggi se precedentemente selezionati
		var game_overed = false;
		var first_mine = true;

		// Called from button
		function check(x, y) {
			
			if (game_overed || visible_matrix[x][y] != null) { return; }

			var item_selected = $('#game #item-' + x + '-' + y);
			if (matrix[x][y] == 'x') {
				if (first_mine) {
					// La prima mina viene spostata in un'altro punto
					// $("#game #item-" + x + "-" + y).removeClass("item-yellow"); // for debug
					placeMines(matrix.length, matrix[0].length, 1);
				} else {
					item_selected.addClass("item-red");
					gameOver(false);
					return;
				}
			}

			first_mine = false;
			count = countNear(x, y)
			visible_matrix[x][y] = count;
			item_selected.addClass("item-green");
			if (count > 0) {
				item_selected.append("<span>"+count+"</span>");
			} else {
				clearNear(x, y);
			}
			if (checkAll()) { gameOver(true); }
		}

		// Called from button
		function toggleRightButton(x, y) {

			if (game_overed || visible_matrix[x][y] != null) { return; }

			var item_selected = $('#game #item-' + x + '-' + y);
			switch (item_selected.text()) {
		        case null || '':
		        	item_selected.html("<span>►</span>");
		        	item_selected.addClass("text-red");
		            break;
		        case '►':
		        	item_selected.html("<span>?</span>");
		        	item_selected.removeClass("text-red");
		            break;
		        default:
		        	item_selected.html(null);
		        	item_selected.removeClass("text-red");

		    }
		}

		function checkAll() {
			for(var x = 0; x < visible_matrix.length; x++) {
				for(var y = 0; y < visible_matrix[x].length; y++) {
					if (visible_matrix[x][y] == null && matrix[x][y] != 'x') { return false; }
				}
			}
			return true;
		}

		function gameOver(win = false) {
			game_overed = true;
			$("#game").addClass("game-over");
			viewAllMines();
			if(win) {
				alert("Hai vinto!");
			} else {
				alert("Hai perso!");
			}
		}

		function viewAllMines() {
			for(var x = 0; x < matrix.length; x++) {
				for(var y = 0; y < matrix[x].length; y++) {
					if (matrix[x][y] == 'x') {
						$('#game #item-' + x + '-' + y).append("<span>X</span>");
					}
				}
			}
		}

		function clearNear(x, y) {
			for(var i = -1; i <= 1; i++) {
				
				// se è stato selezionato una riga vicino al bordo alto, continua
				if (x == 0 && i == -1) { continue; }
				
				// se è stato selezionato una riga vicino al bordo basso, continua
				if (matrix.length == x + 1 && i == 1) { continue; }
				
				for(var j = -1; j <= 1; j++) {
					
					// se è stato selezionato una colonna vicino al limite sinistro, continua
					if (y == 0 && j == -1) { continue; }
					
					// se è stato selezionato una colonna vicino al limite destro, continua
					if (matrix[x + i].length == y + 1 && j == 1) { continue; }
					
					check(x + i, y + j);
				}
			}
		}

		function countNear(x, y) {
			
			counter = 0
			for(var i = -1; i <= 1; i++) {
				
				// se è stato selezionato una riga vicino al bordo alto, continua
				if (x == 0 && i == -1) { continue; }
				
				// se è stato selezionato una riga vicino al bordo basso, continua
				if (matrix.length == x + 1 && i == 1) { continue; }
				
				for(var j = -1; j <= 1; j++) {
					
					// se è stato selezionato una colonna vicino al limite sinistro, continua
					if (y == 0 && j == -1) { continue; }
					
					// se è stato selezionato una colonna vicino al limite destro, continua
					if (matrix[x + i].length == y + 1 && j == 1) { continue; }
					
					counter += matrix[x + i][y + j] == 'x' ? 1 : 0;
				}
			}
			return counter
		}

		// how many milliseconds is a long press?
	    const longpress = 1000;
	    // holds the start time
	    var start_longpress;

		function initializeGame(xs = 9, ys = 9, mines = 10) {
			// Generate the matrix of mines
			matrix = [];
			visible_matrix = [];
			html_to_append = "";
			for(var x = 0; x < xs; x++) {
				html_to_append += "<tr>";
				new_row = [];
				new_visibile_row = [];
				for(var y = 0; y < ys; y++) {
					new_row.push(null);
					new_visibile_row.push(null);
					html_to_append += "<td class='item square' id='item-" + x + "-" + y + "'></td>";
				}
				matrix.push(new_row);
				visible_matrix.push(new_visibile_row);
				html_to_append += "</tr>";
			}

			$("#n-mines").text(mines);
			$("#game").empty();
			$("#game").append(html_to_append);
			$("#game").removeClass("game-over");
			game_overed = false;
			first_mine = true;

			placeMines(xs, ys, mines);

			$('#game .item').on( 'mousedown', function(event) {
		        start_longpress = new Date().getTime();
		    }).on( 'mouseleave', function(event) {
		        start_longpress = 0;
		    }).on( 'mouseup', function(event) {
				var id_array = event.delegateTarget.id.split("-");
				if (id_array.length < 3 || id_array[0] != 'item') { console.log("ERROR id_array"); return; }
				var x = parseInt(id_array[1]);
				var y = parseInt(id_array[2]);

		        if ( new Date().getTime() >= ( start_longpress + longpress ) ) {
	           		toggleRightButton(x, y);
		        } else {
				    switch (event.which) {
				        case 1:
				        	// Left mouse button
				        	check(x, y);
				            break;
				        default:
				        	toggleRightButton(x, y);
				    }
		        }
			});
		}

		function placeMines(xs = 9, ys = 9, mines = 10) {
			for (var mines_placed = 0; mines_placed < mines; true) {
				var rand_x = Math.floor(Math.random() * xs);
				var rand_y = Math.floor(Math.random() * ys);
				if (matrix[rand_x][rand_y] != 'x') {
					matrix[rand_x][rand_y] = 'x';
					mines_placed++;
					// $("#game #item-" + rand_x + "-" + rand_y).addClass("item-yellow"); // for debug
				}
			}
		}
		
		$(document).ready(function() {
			initializeGame();
		});

	</script>
</body>
</html>