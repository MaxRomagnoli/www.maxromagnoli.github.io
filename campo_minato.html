<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Campo Minato</title>
		
	<!-- CSS -->
	<link rel="stylesheet" type="text/css" href="bootstrap-5.0.2-dist/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="win95/win95.css"> <!--https://alexbsoft.github.io/win95.css-->

	<style>
		#game {
			width: 100%;
			margin: 0 auto;
			border: 1px solid #1a1a1a;
			table-layout: fixed;
		}

		#game.game-over {
			opacity: 0.5;
		}

		#game tr td {
			text-align: center;
			border-width: 2px;
		    border-color: buttonface;
		    border-right-color: #424242;
		    border-bottom-color: #424242;
		    background-color: silver;
		    color: black;
		    border-radius: 1px;
		}

		#game tr td span {
			position: absolute;
		    left: 50%;
		    top: 50%;
		    transform: translate(-50%, -50%);
		}

		.item-red {
			background-color: red!important;
		}

		.item-yellow {
			background-color: yellow!important;
		}

		.item-green {
			background-color: lightgreen!important;
		}

		.text-red {
			color: red!important;
		}

		.square {
		  position: relative;
		}

		.square::after {
		  content: "";
		  display: block;
		  padding-bottom: 100%;
		}

	</style>
</head>
<body oncontextmenu="return false;">

	<div class="container" id="page-content">
        <div class="card-deck mb-3 text-center">
            <div class="card my-4">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Campo minato</h4>
                </div>
				<table id="game"></table>
            </div>
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Options</h4>
                </div>
				<button type="button" class="btn btn-lg btn-block btn-outline-primary" onclick="initializeGame()">
					New game easy
				</button>
				<button type="button" class="btn btn-lg btn-block btn-outline-primary" onclick="initializeGame(16, 16, 0.5)">
					New game normal
				</button>
				<button type="button" class="btn btn-lg btn-block btn-outline-primary" onclick="initializeGame(30, 16, 0.7)">
					New game hard
				</button>
            </div>
        </div>
    </div>

	<script src="jquery/3.7.1/jquery.min.js"></script>
	<script>

		var matrix; // array di array, x è una mina
		var visible_matrix; // array di array, vuoti o conteggi se precedentemente selezionati
		var game_overed = false;
		
		// Called from button
		function check(x, y) {
			
			if (game_overed || visible_matrix[x][y] != null) { return; }

			var item_selected = $('#game #item-' + x + '-' + y);
			if (matrix[x][y] == 'x') {
				item_selected.addClass("item-red");
				item_selected.append("<span>X</span>");
				game_over(false);
			}
			else {
				count = count_near(x, y)
				visible_matrix[x][y] = count;
				item_selected.addClass("item-green");
				if (count > 0) {
					item_selected.append("<span>"+count+"</span>");
				} else {
					clear_near(x, y);
				}
				if (check_all()) { game_over(true); }
			}
		}

		// Called from button
		function toggleRightButton(x, y) {

			if (game_overed || visible_matrix[x][y] != null) { return; }

			var item_selected = $('#game #item-' + x + '-' + y);
			switch (item_selected.text()) {
		        case null || '':
		        	item_selected.html("<span>►</span>");
		        	item_selected.addClass("text-red");
		            break;
		        case '►':
		        	item_selected.html("<span>?</span>");
		        	item_selected.removeClass("text-red");
		            break;
		        default:
		        	item_selected.html(null);
		        	item_selected.removeClass("text-red");

		    }
		}

		function check_all() {
			for(var x = 0; x < visible_matrix.length; x++) {
				for(var y = 0; y < visible_matrix[x].length; y++) {
					if (visible_matrix[x][y] == null && matrix[x][y] != 'x') { return false; }
				}
			}
			return true;
		}

		function game_over(win = false) {
			game_overed = true;
			$("#game").addClass("game-over");
			if(win) {
				alert("You win!");
			} else {
				alert("You lose!");
			}
		}

		function clear_near(x, y) {
			for(var i = -1; i <= 1; i++) {
				
				// se è stato selezionato una riga vicino al bordo alto, continua
				if (x == 0 && i == -1) { continue; }
				
				// se è stato selezionato una riga vicino al bordo basso, continua
				if (matrix.length == x + 1 && i == 1) { continue; }
				
				for(var j = -1; j <= 1; j++) {
					
					// se è stato selezionato una colonna vicino al limite sinistro, continua
					if (y == 0 && j == -1) { continue; }
					
					// se è stato selezionato una colonna vicino al limite destro, continua
					if (matrix[x + i].length == y + 1 && j == 1) { continue; }
					
					check(x + i, y + j);
				}
			}
		}

		function count_near(x, y) {
			
			counter = 0
			for(var i = -1; i <= 1; i++) {
				
				// se è stato selezionato una riga vicino al bordo alto, continua
				if (x == 0 && i == -1) { continue; }
				
				// se è stato selezionato una riga vicino al bordo basso, continua
				if (matrix.length == x + 1 && i == 1) { continue; }
				
				for(var j = -1; j <= 1; j++) {
					
					// se è stato selezionato una colonna vicino al limite sinistro, continua
					if (y == 0 && j == -1) { continue; }
					
					// se è stato selezionato una colonna vicino al limite destro, continua
					if (matrix[x + i].length == y + 1 && j == 1) { continue; }
					
					counter += matrix[x + i][y + j] == 'x' ? 1 : 0;
				}
			}
			return counter
		}
			
		function initializeGame(xs = 9, ys = 9, difficult = 0.3) {
			// Generate the matrix of mines
			matrix = [];
			visible_matrix = [];
			html_to_append = "";
			for(var x = 0; x < xs; x++) {
				html_to_append += "<tr>";
				new_row = [];
				new_visibile_row = [];
				for(var y = 0; y < ys; y++) {
					value = Math.random() < difficult ? 'x' : null
					new_row.push(value);
					new_visibile_row.push(null);
					// class_for_debug = value == 'x' ? ' item-yellow' : '';
					// "+class_for_debug+"
					html_to_append += "<td class='item square' id='item-" + x + "-" + y + "'></td>";
				}
				matrix.push(new_row);
				visible_matrix.push(new_visibile_row);
				html_to_append += "</tr>";
			}
			$("#game").empty();
			$("#game").append(html_to_append);
			$("#game").removeClass("game-over");
			game_overed = false;

			$('#game .item').mousedown(function(event) {
	        	
	        	var id_pressed = event.target.id;
	        	var id_array = id_pressed.split("-");
	        	/*console.log(id_array);
	        	console.log(id_array[0]);*/
	        	// if (id_array.length > 2 && id_array[0] == 'item') { }
	        	var x = parseInt(id_array[1]);
	        	var y = parseInt(id_array[2]);

			    switch (event.which) {
			        case 1:
			        	// Left mouse button
			        	check(x, y);
			            break;
			        default:
			        	toggleRightButton(x, y);
			    }
			});
		}
		
		$(document).ready(function() {
			initializeGame();
		});

	</script>
</body>
</html>